<!DOCTYPE html>
<html>
<head>
    <title>Control Panel</title>
    <link href="{{ url_for('static', filename='styles/index.css') }}" rel="stylesheet" type="text/css"/>
    <meta charset="UTF-8">
</head>
<body>
    <div class="header">
      <h2>üõ∞Ô∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–µ—Ñ—Ç–µ–ø—Ä–æ–≤–æ–¥–∞ ‚Äî ArUco 10√ó10</h2>
      <div class="controls">
        <button id="start" class="btn-start" onclick="startMission()">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
        <button id="stop" class="btn-stop" onclick="stopMission()">‚èπÔ∏è –°—Ç–æ–ø</button>
        <button id="kill" class="btn-kill" onclick="kill()">üíÄ Kill</button>
        <span id="status" class="status">–°—Ç–∞—Ç—É—Å: idle</span>
      </div>
    </div>
    
    <div id="map-container">
      <canvas id="map" width="550" height="550"></canvas>
    </div>
    
    <div class="legend">
      <div class="legend-item"><span class="legend-color drone-color"></span> –î—Ä–æ–Ω</div>
      <div class="legend-item"><span class="legend-color tap-color"></span> –í—Ä–µ–∑–∫–∞</div>
      <div class="legend-item"><span class="legend-color marker-color"></span> ArUco-–º–∞—Ä–∫–µ—Ä</div>
      <div class="legend-item">–®–∞–≥ —Å–µ—Ç–∫–∏: 1 –º</div>
    </div>
    
    <h3>–ù–∞–π–¥–µ–Ω–Ω—ã–µ –≤—Ä–µ–∑–∫–∏:</h3>
    <ul id="taps-list"></ul>
    
    <script>
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    const MAP_SIZE_M = 10;           // 10√ó10 –º
    const PX_PER_M = 50;             // –º–∞—Å—à—Ç–∞–±: 1 –º = 50 px
    const OFFSET_X = 25;             // –æ—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞/—Å–≤–µ—Ä—Ö—É (–¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ —É –∫—Ä–∞—è)
    const OFFSET_Y = 25;
    
    let drone = { x: 0, y: 0, yaw: 0 };
    let taps = [];                   // [{x, y}, ...]
    let status = 'idle';
    
    const canvas = document.getElementById('map');
    const ctx = canvas.getContext('2d');
    
    // --- –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ä—Ç—ã ---
    function drawMap() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    
      // –°–µ—Ç–∫–∞ ArUco (1 –º —à–∞–≥)
      ctx.strokeStyle = '#e0e0e0';
      ctx.lineWidth = 1;
      for (let i = 0; i <= MAP_SIZE_M; i++) {
        const x = OFFSET_X + i * PX_PER_M;
        const y0 = OFFSET_Y;
        const y1 = OFFSET_Y + MAP_SIZE_M * PX_PER_M;
        ctx.beginPath();
        ctx.moveTo(x, y0); ctx.lineTo(x, y1);
        ctx.moveTo(y0, x); ctx.lineTo(y1, x); // –¥–∞, —Ç–∞–∫ ‚Äî –¥–ª—è –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–π —Å–µ—Ç–∫–∏
        ctx.stroke();
      }
    
      // ArUco-–º–∞—Ä–∫–µ—Ä—ã (–≤ —É–∑–ª–∞—Ö)
      ctx.fillStyle = '#6c757d';
      ctx.font = '10px Arial';
      for (let i = 0; i < 10; i++) {
        for (let j = 0; j < 10; j++) {
          const cx = OFFSET_X + i * PX_PER_M;
          const cy = OFFSET_Y + j * PX_PER_M;
          ctx.fillRect(cx - 2, cy - 2, 4, 4);
          // ctx.fillText(`(${i},${j})`, cx + 4, cy - 4); // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
        }
      }
    
      // –í—Ä–µ–∑–∫–∏
      ctx.fillStyle = '#dc3545';
      taps.forEach(t => {
        const x = OFFSET_X + t.x * PX_PER_M;
        const y = OFFSET_Y + (MAP_SIZE_M - t.y) * PX_PER_M; // –∏–Ω–≤–µ—Ä—Å–∏—è Y: 0 –≤–Ω–∏–∑—É
        ctx.beginPath();
        ctx.arc(x, y, 8, 0, 2 * Math.PI);
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();
      });
    
      // –î—Ä–æ–Ω (—Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫, –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ yaw)
      const dx = OFFSET_X + drone.x * PX_PER_M;
      const dy = OFFSET_Y + (MAP_SIZE_M - drone.y) * PX_PER_M;
      ctx.save();
      ctx.translate(dx, dy);
      ctx.rotate(drone.yaw);
      ctx.fillStyle = '#007bff';
      ctx.beginPath();
      ctx.moveTo(0, -10);
      ctx.lineTo(-6, 8);
      ctx.lineTo(6, 8);
      ctx.closePath();
      ctx.fill();
      ctx.restore();
    
      // –ü–æ–¥–ø–∏—Å–∏ –æ—Å–µ–π
      ctx.fillStyle = '#333';
      ctx.font = '12px Arial';
      ctx.fillText('X ‚Üí', OFFSET_X + MAP_SIZE_M * PX_PER_M + 10, OFFSET_Y + MAP_SIZE_M * PX_PER_M + 15);
      ctx.save();
      ctx.translate(10, OFFSET_Y + MAP_SIZE_M * PX_PER_M + 10);
      ctx.rotate(-Math.PI / 2);
      ctx.fillText('Y ‚Üë', 0, 0);
      ctx.restore();
    }
    
    // --- –ó–∞–ø—Ä–æ—Å—ã –∫ —Å–µ—Ä–≤–µ—Ä—É ---
    async function fetchDrone() {
      try {
        const res = await fetch('/drone');
        const data = await res.json();
        drone = { x: data.x || 0, y: data.y || 0, yaw: data.yaw || 0 };
      } catch (e) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –¥—Ä–æ–Ω–∞');
      }
    }
    
    async function fetchTaps() {
      try {
        const res = await fetch('/taps');
        const data = await res.json(); // [{x:1.2, y:1.5}, ...]
        taps = data;
      } catch (e) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Ä–µ–∑–æ–∫');
      }
    }
    
    async function fetchStatus() {
      try {
        const res = await fetch('/status');
        const data = await res.json();
        status = data.status || 'unknown';
        document.getElementById('status').innerText = `–°—Ç–∞—Ç—É—Å: ${status}`;
        document.getElementById('status').className = `status status-${status}`;
        const startBtn = document.getElementById('start');
        startBtn.disabled = (status === 'flying');
      } catch (e) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å');
      }
    }
    
    // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ---
    function update() {
      Promise.all([fetchDrone(), fetchTaps(), fetchStatus()]).then(() => {
        drawMap();
        updateTapsList();
      });
    }
    
    function updateTapsList() {
      const list = document.getElementById('taps-list');
      list.innerHTML = taps.length === 0
        ? '<li>–í—Ä–µ–∑–∫–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã</li>'
        : taps.map((t, i) => `<li><strong>#${i+1}</strong>: (${t.x.toFixed(2)}, ${t.y.toFixed(2)}) –º</li>`).join('');
    }
    
    // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ---
    async function sendCommand(cmd) {
      try {
        await fetch('/command', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ command: cmd })
        });
      } catch (e) {
        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã');
      }
    }
    function startMission() { sendCommand('start'); }
    function stopMission()  { sendCommand('stop'); }
    function kill()         { sendCommand('kill'); }
    
    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    drawMap();
    setInterval(update, 300); // 3 —Ä–∞–∑–∞ –≤ —Å–µ–∫—É–Ω–¥—É
    
    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–ª–µ—Å–æ–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    canvas.addEventListener('wheel', (e) => {
      e.preventDefault();
      const delta = e.deltaY > 0 ? -0.1 : 0.1;
      // –ø—Ä–æ—Å—Ç–æ–π zoom: –æ–±–Ω–æ–≤–∏—Ç—å PX_PER_M (—Ä–µ–∞–ª–∏–∑—É–π—Ç–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
    }, { passive: false });
    </script>
    
</body>
</html>
